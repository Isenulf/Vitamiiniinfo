<div class="cookie-banner" id="cookie-banner" hidden>
  <p>
    Kasutame vajalikke küpsiseid veebilehe tööks ning analüütika küpsiseid, et parandada kasutajakogemust.
  </p>
  <button type="button" class="cta" data-cookie-action="accept-all">Nõustu kõigiga</button>
  <div class="secondary-actions">
    <button type="button" data-cookie-action="accept-necessary">Nõustun ainult vajalike küpsistega</button>
    <button type="button" data-cookie-action="open-settings">Küpsiste seaded</button>
  </div>
</div>

<script is:inline>
  (() => {
    const STORAGE_KEY = 'cookie-consent';
    const CONSENT_COOKIE_KEY = 'cookie-consent';
    const banner = document.getElementById('cookie-banner');

    const parseCookieConsent = () => {
      const match = document.cookie
        .split('; ')
        .find((row) => row.startsWith(`${CONSENT_COOKIE_KEY}=`));

      if (!match) return null;

      const encoded = match.slice(CONSENT_COOKIE_KEY.length + 1);
      try {
        const parsed = JSON.parse(decodeURIComponent(encoded));
        if (typeof parsed?.analytics === 'boolean') {
          return { necessary: true, analytics: parsed.analytics };
        }
      } catch {
        return null;
      }

      return null;
    };

    const writeConsentCookie = (consent) => {
      const maxAge = 60 * 60 * 24 * 365;
      document.cookie = `${CONSENT_COOKIE_KEY}=${encodeURIComponent(JSON.stringify(consent))}; Path=/; Max-Age=${maxAge}; SameSite=Lax; Secure`;
    };

    const parseConsent = () => {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) {
        return parseCookieConsent();
      }
      if (stored === 'accepted') return { necessary: true, analytics: true };
      try {
        const parsed = JSON.parse(stored);
        if (typeof parsed?.analytics === 'boolean') {
          return { necessary: true, analytics: parsed.analytics };
        }
      } catch {
        return null;
      }
      return null;
    };

    const saveConsent = (analytics) => {
      const consent = { necessary: true, analytics };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(consent));
      writeConsentCookie(consent);
      window.__updateCookieConsent?.(consent);
      window.dispatchEvent(new CustomEvent('cookie-consent:updated', { detail: consent }));
      banner?.setAttribute('hidden', 'hidden');
    };

    const hasConsent = parseConsent() !== null;
    if (!hasConsent) {
      banner?.removeAttribute('hidden');
    }

    if (!banner) return;

    banner.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const action = target.dataset.cookieAction;

      if (action === 'accept-all') {
        saveConsent(true);
      }

      if (action === 'accept-necessary') {
        saveConsent(false);
      }

      if (action === 'open-settings') {
        window.dispatchEvent(new CustomEvent('cookie-consent:open-settings'));
      }
    });

    window.addEventListener('cookie-consent:updated', () => {
      banner.setAttribute('hidden', 'hidden');
    });
  })();
</script>

<style>
  .cookie-banner[hidden] {
    display: none;
  }

  .cookie-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 120;
    background: #fff;
    border-top: 1px solid #e6e2de;
    box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: grid;
    gap: 0.75rem;
  }

  .cookie-banner p {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.4;
  }

  .cookie-banner button {
    border: 1px solid #d5d0cb;
    border-radius: 0.5rem;
    background: #fff;
    color: #1d1d1d;
    font-size: 0.95rem;
    line-height: 1.2;
    padding: 0.7rem 0.9rem;
    cursor: pointer;
  }

  .cookie-banner .cta {
    border: none;
    background: #f18700;
    color: #fff;
    font-weight: 700;
    font-size: 1rem;
    min-height: 48px;
  }

  .cookie-banner .secondary-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
  }

  @media (min-width: 720px) {
    .cookie-banner {
      left: 50%;
      transform: translateX(-50%);
      width: min(760px, calc(100% - 1.5rem));
      border: 1px solid #e6e2de;
      border-radius: 0.75rem 0.75rem 0 0;
    }
  }
</style>
