---
import SiteLayout from './SiteLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import ArticleCard from '../components/ArticleCard.astro';
import Schema from '../components/Schema.astro';
import { allArticles, buildBreadcrumbs, getArticleBlocks, getArticleByUrl } from '../data/articles';

const { frontmatter } = Astro.props;
const pageUrl = `${Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`}`;
const current = getArticleByUrl(pageUrl);
const blocks = current ? getArticleBlocks(current, allArticles) : null;
const mainGuide = current?.mainGuide ? getArticleByUrl(current.mainGuide) : null;
const canonical = `https://vitamiiniinfo.ee${pageUrl}`;
---

<SiteLayout title={frontmatter.seoTitle || frontmatter.title} description={frontmatter.seoDescription || frontmatter.description || frontmatter.title} canonical={canonical} type="article">
  <Schema
    slot="head"
    pageUrl={pageUrl}
    canonicalUrl={canonical}
    pageTitle={frontmatter.title}
    pageDescription={frontmatter.description || frontmatter.title}
    article={current || undefined}
  />
  <Breadcrumbs items={buildBreadcrumbs(pageUrl)} />
  <article class="article">
    <h1>{frontmatter.title}</h1>
    {frontmatter.description && <p>{frontmatter.description}</p>}
    {mainGuide && <aside class="main-guide"><p>Peamine juhend</p><a href={mainGuide.url}>{mainGuide.title}</a></aside>}
    <slot />
  </article>

  {blocks && blocks.supporting.items.length > 0 && (
    <section>
      <h2>{blocks.supporting.title}</h2>
      <div class="grid cols-2">{blocks.supporting.items.map((entry) => <ArticleCard article={entry} />)}</div>
      {blocks.supporting.hasMore && blocks.supporting.moreLink && <p><a href={blocks.supporting.moreLink}>Loe rohkem</a></p>}
    </section>
  )}

  {blocks && blocks.cluster.items.length > 0 && (
    <section>
      <h2>{blocks.cluster.title}</h2>
      <div class="grid cols-3">{blocks.cluster.items.map((entry) => <ArticleCard article={entry} />)}</div>
      {blocks.cluster.hasMore && blocks.cluster.moreLink && <p><a href={blocks.cluster.moreLink}>Loe rohkem</a></p>}
    </section>
  )}

  {blocks && blocks.editorial.items.length > 0 && (
    <section>
      <h2>{blocks.editorial.title}</h2>
      <div class="grid cols-2">{blocks.editorial.items.map((entry) => <ArticleCard article={entry} />)}</div>
      {blocks.editorial.hasMore && blocks.editorial.moreLink && <p><a href={blocks.editorial.moreLink}>Loe rohkem</a></p>}
    </section>
  )}
</SiteLayout>
